<!DOCTYPE html>
<html>
<head>
    <title>RSS Feed Toggle Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-box { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .settings-toggle-item { margin: 5px 0; }
        .pass { color: green; }
        .fail { color: red; }
        #console { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>
    <h1>RSS Feed Toggle Test</h1>
    
    <div class="test-box">
        <h3>Test Toggles</h3>
        <div class="settings-toggle-item" data-setting="rss-bloomberg">
            <label>Bloomberg: </label>
            <input type="checkbox" onchange="testToggle(this)">
        </div>
        <div class="settings-toggle-item" data-setting="rss-techcrunch">
            <label>TechCrunch: </label>
            <input type="checkbox" onchange="testToggle(this)">
        </div>
        <div class="settings-toggle-item" data-setting="rss-nyt">
            <label>NY Times: </label>
            <input type="checkbox" onchange="testToggle(this)" checked>
        </div>
    </div>
    
    <div class="test-box">
        <h3>Console Output</h3>
        <div id="console"></div>
    </div>
    
    <script>
        // Mock environment
        let settings = { 'rss-feeds': ['nyt'] };
        let isLoggedIn = false;
        let hashedUser = null;
        let live_news_updates = false;
        let rssIsDirty = false;
        let rssDrop = false;
        let isUpdatingRSSUI = false;
        let callCount = 0;
        
        // Capture console output
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        console.log = function(...args) {
            callCount++;
            const message = args.join(' ');
            consoleDiv.innerHTML += `${callCount}: ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            originalLog(...args);
            
            // Detect infinite loop
            if (callCount > 20) {
                consoleDiv.innerHTML += `<span class="fail">INFINITE LOOP DETECTED! Stopping test.</span>\n`;
                throw new Error('Infinite loop detected');
            }
        };
        
        // Mock updateSetting function
        function updateRSSFeedsUI(feedsArray) {
            console.log('updateRSSFeedsUI called with:', feedsArray);
            isUpdatingRSSUI = true;
            
            // Update UI checkboxes with the new approach - removing onchange attribute temporarily
            document.querySelectorAll('[data-setting^="rss-"]').forEach(item => {
                const settingName = item.getAttribute('data-setting');
                const feedId = settingName.substring(4);
                const checkbox = item.querySelector('input');
                if (checkbox) {
                    // Temporarily remove the inline onchange attribute to prevent triggering events
                    const originalOnChange = checkbox.getAttribute('onchange');
                    checkbox.removeAttribute('onchange');
                    
                    // Update the checkbox state
                    checkbox.checked = feedsArray.includes(feedId);
                    
                    // Restore the onchange attribute
                    if (originalOnChange) {
                        checkbox.setAttribute('onchange', originalOnChange);
                    }
                }
            });
            
            setTimeout(() => {
                isUpdatingRSSUI = false;
            }, 0);
        }
        
        function updateSetting(key, value) {
            console.log(`updateSetting called: ${key} = ${value}`);
            if (key === 'rss-feeds') {
                updateRSSFeedsUI(value);
            }
        }
        
        // Simplified saveSetting function (our fix)
        async function saveSetting(key, value) {
            console.log(`Setting "${key}" updated to ${value} (local)`);
            
            // Handle backward compatibility with individual RSS settings
            if (key.startsWith('rss-')) {
                const feedId = key.substring(4);
                const currentFeeds = settings['rss-feeds'] || [];
                let newFeeds;
                
                if (value) {
                    // Add feed if not already present
                    newFeeds = currentFeeds.includes(feedId) ? currentFeeds : [...currentFeeds, feedId];
                } else {
                    // Remove feed
                    newFeeds = currentFeeds.filter(feed => feed !== feedId);
                }
                
                // Update the rss-feeds setting directly without recursive call
                key = 'rss-feeds';
                value = newFeeds;
            }
            
            // Handle local settings
            settings[key] = value;
            
            // Update the interface
            updateSetting(key, value);
            
            console.log('saveSetting completed successfully');
        }
        
        // Test function
        function testToggle(element) {
            if (isUpdatingRSSUI) {
                console.log('Ignoring toggle during RSS UI update to prevent infinite loop');
                return;
            }
            
            console.log('--- Test Toggle Started ---');
            const settingItem = element.closest('[data-setting]');
            if (settingItem && settingItem.dataset.setting) {
                const key = settingItem.dataset.setting;
                const value = element.checked;
                console.log(`Testing: ${key} = ${value}`);
                
                try {
                    saveSetting(key, value);
                    console.log(`<span class="pass">✓ SUCCESS: No infinite loop!</span>`);
                } catch(e) {
                    console.log(`<span class="fail">✗ ERROR: ${e.message}</span>`);
                }
            }
            console.log('--- Test Toggle Completed ---');
        }
        
        console.log('Test page loaded. Click the checkboxes to test RSS feed toggles.');
        console.log('Current RSS feeds:', settings['rss-feeds']);
    </script>
</body>
</html>