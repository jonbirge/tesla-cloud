<!DOCTYPE html>
<html>
<head>
    <title>Debug RSS Settings Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-box { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .settings-toggle-item { margin: 5px 0; }
        .pass { color: green; }
        .fail { color: red; }
        #console { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Debug RSS Settings Fix</h1>
    
    <div class="test-box">
        <h3>Test Toggles</h3>
        <div class="settings-toggle-item" data-setting="rss-bloomberg">
            <label>Bloomberg: </label>
            <input type="checkbox" onchange="testToggle(this)">
        </div>
        <div class="settings-toggle-item" data-setting="rss-techcrunch">
            <label>TechCrunch: </label>
            <input type="checkbox" onchange="testToggle(this)">
        </div>
        <div class="settings-toggle-item" data-setting="rss-nyt">
            <label>NY Times: </label>
            <input type="checkbox" onchange="testToggle(this)" checked>
        </div>
    </div>
    
    <div class="test-box">
        <h3>Console Output</h3>
        <div id="console"></div>
    </div>
    
    <script>
        // Mock environment
        let settings = { 'rss-feeds': ['nyt'] };
        let isLoggedIn = false;
        let hashedUser = null;
        let live_news_updates = false;
        let rssIsDirty = false;
        let rssDrop = false;
        let isUpdatingRSSUI = false;
        let callCount = 0;
        let callStack = [];
        
        // Capture console output
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        console.log = function(...args) {
            callCount++;
            const stack = new Error().stack.split('\n')[2] || 'unknown';
            const caller = stack.trim();
            const message = args.join(' ');
            callStack.push(`${callCount}: ${message} [${caller}]`);
            
            consoleDiv.innerHTML = callStack.join('\n');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            originalLog(...args);
            
            // Detect infinite loop
            if (callCount > 50) {
                consoleDiv.innerHTML += `\n<span class="fail">INFINITE LOOP DETECTED! Call stack:</span>\n`;
                callStack.slice(-10).forEach(entry => {
                    consoleDiv.innerHTML += entry + '\n';
                });
                throw new Error('Infinite loop detected');
            }
        };
        
        // Mock updateSetting function
        function updateRSSFeedsUI(feedsArray) {
            console.log('>>> updateRSSFeedsUI START');
            console.log('updateRSSFeedsUI called with:', feedsArray);
            isUpdatingRSSUI = true;
            
            // Update UI checkboxes with the new approach - removing onchange attribute temporarily
            document.querySelectorAll('[data-setting^="rss-"]').forEach(item => {
                const settingName = item.getAttribute('data-setting');
                const feedId = settingName.substring(4);
                const checkbox = item.querySelector('input');
                if (checkbox) {
                    console.log(`Updating checkbox ${settingName}: ${feedsArray.includes(feedId)}`);
                    
                    // Temporarily remove the inline onchange attribute to prevent triggering events
                    const originalOnChange = checkbox.getAttribute('onchange');
                    checkbox.removeAttribute('onchange');
                    console.log(`Removed onchange for ${settingName}`);
                    
                    // Update the checkbox state
                    checkbox.checked = feedsArray.includes(feedId);
                    console.log(`Set checked for ${settingName} to ${checkbox.checked}`);
                    
                    // Restore the onchange attribute
                    if (originalOnChange) {
                        checkbox.setAttribute('onchange', originalOnChange);
                        console.log(`Restored onchange for ${settingName}`);
                    }
                }
            });
            
            setTimeout(() => {
                isUpdatingRSSUI = false;
                console.log('isUpdatingRSSUI set to false');
            }, 0);
            
            console.log('<<< updateRSSFeedsUI END');
        }
        
        function updateSetting(key, value) {
            console.log(`>>> updateSetting START: ${key} = ${JSON.stringify(value)}`);
            if (key === 'rss-feeds') {
                updateRSSFeedsUI(value);
            }
            console.log(`<<< updateSetting END: ${key}`);
        }
        
        // Simplified saveSetting function (our fix)
        async function saveSetting(key, value) {
            console.log(`>>> saveSetting START: ${key} = ${value}`);
            
            // Handle backward compatibility with individual RSS settings
            if (key.startsWith('rss-')) {
                console.log('Processing RSS setting...');
                const feedId = key.substring(4);
                const currentFeeds = settings['rss-feeds'] || [];
                let newFeeds;
                
                if (value) {
                    // Add feed if not already present
                    newFeeds = currentFeeds.includes(feedId) ? currentFeeds : [...currentFeeds, feedId];
                } else {
                    // Remove feed
                    newFeeds = currentFeeds.filter(feed => feed !== feedId);
                }
                
                console.log(`Converting ${key}=${value} to rss-feeds=${JSON.stringify(newFeeds)}`);
                
                // Update the rss-feeds setting directly without recursive call
                key = 'rss-feeds';
                value = newFeeds;
            }
            
            // Handle local settings
            console.log(`Updating local settings: ${key} = ${JSON.stringify(value)}`);
            settings[key] = value;
            
            // Update the interface
            console.log('Calling updateSetting...');
            updateSetting(key, value);
            
            console.log('<<< saveSetting END');
        }
        
        // Test function
        function testToggle(element) {
            console.log('=== TEST TOGGLE START ===');
            
            if (isUpdatingRSSUI) {
                console.log('Ignoring toggle during RSS UI update to prevent infinite loop');
                return;
            }
            
            const settingItem = element.closest('[data-setting]');
            if (settingItem && settingItem.dataset.setting) {
                const key = settingItem.dataset.setting;
                const value = element.checked;
                console.log(`Testing: ${key} = ${value}`);
                
                try {
                    saveSetting(key, value);
                    console.log(`<span class="pass">✓ SUCCESS: No infinite loop!</span>`);
                } catch(e) {
                    console.log(`<span class="fail">✗ ERROR: ${e.message}</span>`);
                }
            }
            console.log('=== TEST TOGGLE END ===');
        }
        
        console.log('Debug page loaded. Click the checkboxes to test RSS feed toggles.');
        console.log('Current RSS feeds:', settings['rss-feeds']);
    </script>
</body>
</html>